
import admin from 'firebase-admin';

// --- START: SINGLETON PATTERN ---
// This ensures that we only initialize the Firebase Admin SDK once,
// no matter how many times these helper functions are imported.

let adminInstance = null;

function getServiceAccount() {
  // This function remains the same, it correctly gets credentials from env vars.
  if (process.env.FIREBASE_SERVICE_ACCOUNT_JSON) {
    console.log("[firebase-admin] Initializing with FIREBASE_SERVICE_ACCOUNT_JSON from .env.local.");
    try {
      return JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT_JSON);
    } catch (e) {
      console.error("[firebase-admin] CRITICAL: Failed to parse FIREBASE_SERVICE_ACCOUNT_JSON.", e);
      return null;
    }
  }

  if (process.env.FIREBASE_SERVICE_ACCOUNT_BASE64) {
    console.log("[firebase-admin] Initializing with Base64 encoded Vercel environment variable.");
    try {
      const decodedServiceAccount = Buffer.from(process.env.FIREBASE_SERVICE_ACCOUNT_BASE64, 'base64').toString('utf-8');
      return JSON.parse(decodedServiceAccount);
    } catch (e) {
      console.error("[firebase-admin] CRITICAL: Failed to parse Base64 encoded service account.", e);
      return null;
    }
  }
  
  console.error("[firebase-admin] FATAL: No Firebase service account credentials found.");
  return null;
}

function initializeAdmin() {
  if (admin.apps.length > 0) {
    return admin;
  }

  const serviceAccount = getServiceAccount();
  if (serviceAccount) {
    admin.initializeApp({
      credential: admin.credential.cert(serviceAccount)
    });
    console.log("[firebase-admin] Firebase Admin SDK initialized successfully.");
    return admin;
  }
  
  // This will only be reached if no credentials are found at all.
  console.error("[firebase-admin] CRITICAL: Firebase Admin SDK initialization failed because no credentials were found.");
  // We don't throw an error here to prevent server crashes on build,
  // but subsequent calls to getAuth/getFirestore will fail.
  return null;
}

const getAdminInstance = () => {
    if (!adminInstance) {
        adminInstance = initializeAdmin();
    }
    if (!adminInstance) {
        // This is the safety net. If initialization failed, every call will throw a clear error.
        throw new Error("Firebase Admin SDK is not initialized. Check server logs for credential errors.");
    }
    return adminInstance;
};
// --- END: SINGLETON PATTERN ---


const getAuth = async () => {
    const adminSdk = getAdminInstance();
    return adminSdk.auth();
};

const getFirestore = async () => {
    const adminSdk = getAdminInstance();
    return adminSdk.firestore();
};

const FieldValue = admin.firestore.FieldValue;
const GeoPoint = admin.firestore.GeoPoint;


/**
 * Verifies the authorization token from a request and returns the user's UID.
 * This is the central point for all API authentication checks.
 * @param {Request} req The incoming Next.js request object.
 * @returns {Promise<string>} The user's UID.
 * @throws Will throw an error with a status code if the token is missing or invalid.
 */
const verifyAndGetUid = async (req) => {
  const auth = await getAuth();
  const authHeader = req.headers.get('authorization');

  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    throw { message: 'Authorization token is missing or malformed.', status: 401 };
  }
  const token = authHeader.split('Bearer ')[1];
  
  try {
      const decodedToken = await auth.verifyIdToken(token);
      return decodedToken.uid;
  } catch (error) {
      console.error("[verifyAndGetUid] Error verifying token:", error.message);
      throw { message: `Token verification failed: ${error.message}`, status: 403 };
  }
}


export { getAuth, getFirestore, FieldValue, GeoPoint, verifyAndGetUid };
